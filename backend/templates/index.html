<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper ìë§‰ ìƒì„±ê¸°</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        th.lang-code, td.lang-code {
            min-width: 10px !important;
            max-width: 18px !important;
            text-align: center;
            font-size: 0.95em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th.subtitle-status, td.subtitle-status { min-width: 36px; max-width: 60px; text-align: center; }
        th.subtitle-preview, td.subtitle-preview { min-width: 48px; max-width: 100px; }
        th.extract-embedded, td.extract-embedded { min-width: 24px; max-width: 32px; text-align: center; }
        .extract-embedded button {
            white-space: nowrap;
            font-size: 0.9em;
            padding: 2px 4px;
            min-width: 0;
            max-width: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .job-btn {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 2px 0 0;
            font-size: 1.15em;
            cursor: pointer;
            border-radius: 0 !important;
            transition: none !important;
            color: inherit;
        }
        .job-btn:hover, .job-btn:active, .job-btn:focus {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            color: inherit;
        }
        @media (max-width: 900px) {
            #sidebar-toggle { display: block !important; }
            .directory-browser {
                position: fixed;
                left: 0; top: 0; bottom: 0;
                width: 80vw; max-width: 320px;
                background: #f0f4f8;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.25s;
                box-shadow: 2px 0 8px rgba(0,0,0,0.08);
            }
            .directory-browser.open {
                transform: translateX(0);
            }
            .directory-browser:not(.open) { display: none !important; }
            .container { flex-direction: column; }
        }
        @media (min-width: 901px) {
            #sidebar-toggle { display: none !important; }
            .directory-browser {
                position: static !important;
                transform: none !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: none !important;
            }
        }
    </style>
</head>
<body>
    <h1 id="app-title" style="cursor:pointer;">Whisper ìë§‰ ìƒì„±ê¸°</h1>

    <div class="container">
        <!-- [íƒìƒ‰ê¸° ì˜ì—­ ì‹œì‘] -->
        <div id="directory-browser" class="directory-browser">
            <h2>íƒìƒ‰ê¸°</h2>
            <div id="current-path-display">í˜„ì¬ ê²½ë¡œ: /{{ initial_path }}</div>
            <!-- ë””ë ‰í† ë¦¬ íŠ¸ë¦¬ í‘œì‹œ ì˜ì—­ -->
            <ul id="directory-list">
                <li>ë¡œë”© ì¤‘...</li>
            </ul>
            <div class="directory-actions">
                <label for="subtitle-filter">ìë§‰ í•„í„°:</label>
                <select id="subtitle-filter">
                    <option value="all">ì „ì²´</option>
                    <option value="no_subtitle" selected>ìë§‰ì—†ëŠ” ë¯¸ë””ì–´ë§Œ</option>
                    <option value="has_subtitle">ìë§‰ìˆëŠ” ë¯¸ë””ì–´ë§Œ</option>
                </select>
                <button id="scan-directory" class="scan-button">í˜„ì¬ í´ë” ê²€ìƒ‰</button>
            </div>
            <!-- ì‘ì—… í˜„í™© íŒ¨ë„ ì‹œì‘ -->
            <div id="job-status-panel" class="job-status-panel" style="margin-top:18px;padding:12px;background:#f6fafd;border-radius:8px;border:1px solid #e0e6ef;">
                <h3 style="margin:0 0 8px 0;font-size:1.05em;">ì‘ì—… í˜„í™©</h3>
                <ul id="job-list" style="list-style:none;padding:0;margin:0;min-height:32px;"></ul>
            </div>
            <!-- ì‘ì—… í˜„í™© íŒ¨ë„ ë -->
        </div>
        <!-- [íƒìƒ‰ê¸° ì˜ì—­ ë] -->

        <!-- [íŒŒì¼ ëª©ë¡ ì˜ì—­ ì‹œì‘] -->
        <div id="file-list-container" class="file-list-container">
            <h2 id="file-list-header">ë¯¸ë””ì–´ íŒŒì¼ ëª©ë¡ (/{{ initial_path }})</h2>
            <div class="controls" id="controls">
                <!-- ê²€ìƒ‰ í•„í„° ì¶”ê°€ -->
                <div class="search-filter">
                    <input type="text" id="file-search" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." class="search-input">
                </div>
                <!-- ê¸°ì¡´ í•„í„° -->
                <div class="filters" id="filters">
                    <label><input type="checkbox" id="filter-video" onchange="filterTableClientSide()" {{ "checked" if filter_video else "" }}> ì˜ìƒ</label>
                    <label><input type="checkbox" id="filter-audio" onchange="filterTableClientSide()" {{ "checked" if filter_audio else "" }}> ì˜¤ë””ì˜¤</label>
                </div>
            </div>
            <!-- íƒ­ UI ì‹œì‘ -->
            <div class="tab-bar">
                <button class="tab-btn active" id="tab-extract">ìë§‰ ë³€í™˜ ë° ì¶”ì¶œ</button>
                <button class="tab-btn" id="tab-download">AI ìë§‰ ë‹¤ìš´ë¡œë“œ</button>
                <button class="tab-btn" id="tab-whisper">ìŒì„±ìœ¼ë¡œ ìë§‰ ìƒì„±</button>
            </div>
            <div class="tab-content active" id="tab-content-extract">ìë§‰ ì¶”ì¶œ</div>
            <div class="tab-content" id="tab-content-download">
                <div class="actions" id="actions-download">
                    <label for="download-lang">ì–¸ì–´:</label>
                    <select id="download-lang">
                        <option value="en">ì˜ì–´ (en)</option>
                        <option value="ko">í•œêµ­ì–´ (ko)</option>
                        <option value="ja">ì¼ë³¸ì–´ (ja)</option>
                        <option value="zh">ì¤‘êµ­ì–´ (zh)</option>
                        <option value="fr">í”„ë‘ìŠ¤ì–´ (fr)</option>
                    </select>
                    <button id="select-all-download">ì „ì²´ ì„ íƒ</button>
                    <button id="deselect-all-download">ì „ì²´ í•´ì œ</button>
                    <button id="run-download" class="cta-button">ì„ íƒ íŒŒì¼ AI ìë§‰ ë‹¤ìš´ë¡œë“œ</button>
                    <span id="download-status" style="margin-left:12px;color:#888;font-size:0.97em;"></span>
                </div>
                <div style="margin-top:12px;color:#888;font-size:0.98em;">
                    â€» ìµœì¢… ìë§‰(.srt)ì€ ì›ë³¸ ë¯¸ë””ì–´ íŒŒì¼ê³¼ ê°™ì€ í´ë”ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="tab-content" id="tab-content-whisper">
                <div class="actions" id="actions">
                    <label for="model-select">ëª¨ë¸:</label>
                    <select id="model-select">
                        <option value="tiny" title="ê°€ì¥ ë¹ ë¦„, ì €ì‚¬ì–‘ PC/í…ŒìŠ¤íŠ¸ìš©">Tiny</option>
                        <option value="base" title="ë¹ ë¦„, ì¼ìƒì  ì‚¬ìš©/ì €ì‚¬ì–‘ PC">Base</option>
                        <option value="small" title="ì¤‘ê°„ ì†ë„, ì¼ë°˜ PC/ì„œë²„">Small</option>
                        <option value="medium" title="ëŠë¦¼, ê³ ì„±ëŠ¥ PC/ì„œë²„">Medium</option>
                    </select>
                    <span id="model-desc" style="margin-left:8px;color:#888;font-size:0.97em;"></span>
                    <label for="whisper-lang">ì–¸ì–´:</label>
                    <select id="whisper-lang">
                        <optgroup label="ìë™/ê¶Œì¥">
                            <option value="auto" title="ìë™ ì¸ì‹ (ê¶Œì¥)" selected>ìë™ ì¸ì‹</option>
                        </optgroup>
                        <optgroup label="ì£¼ìš” ì–¸ì–´">
                            <option value="en" title="ì˜ì–´">ì˜ì–´ (en)</option>
                            <option value="ko" title="í•œêµ­ì–´">í•œêµ­ì–´ (ko)</option>
                            <option value="ja" title="ì¼ë³¸ì–´">ì¼ë³¸ì–´ (ja)</option>
                            <option value="zh" title="ì¤‘êµ­ì–´">ì¤‘êµ­ì–´ (zh)</option>
                            <option value="fr" title="í”„ë‘ìŠ¤ì–´">í”„ë‘ìŠ¤ì–´ (fr)</option>
                        </optgroup>
                    </select>
                    <span id="lang-desc" style="margin-left:8px;color:#888;font-size:0.97em;"></span>
                    <button id="select-all">ì „ì²´ ì„ íƒ</button>
                    <button id="deselect-all">ì „ì²´ í•´ì œ</button>
                    <button id="run-whisper" class="cta-button">ì„ íƒ íŒŒì¼ ìë§‰ ìƒì„±</button>
                    <button id="stop-whisper" class="stop-button" style="display: none;">ì²˜ë¦¬ ì¤‘ì§€</button>
                </div>
            </div>
            <!-- íƒ­ UI ë -->
            <!-- íŒŒì¼ ëª©ë¡/ì™„ë£Œ íŒŒì¼/ë°°ì¹˜ ìƒíƒœ: íƒ­ UIì™€ ë¶„ë¦¬, í•­ìƒ ì•„ë˜ì— ê³ ì • -->
            <div class="table-wrapper" id="table-wrapper">
                <table style="table-layout:fixed;width:100%;">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-header"></th>
                            <th class="status">ìƒíƒœ</th>
                            <th class="progress">ì§„í–‰ë¥ </th>
                            <th>íŒŒì¼ëª…</th>
                            <th class="lang-code" title="ì–¸ì–´">ì–¸ì–´</th>
                            <th class="subtitle-status">ìƒíƒœ</th>
                            <th class="subtitle-preview">ë¯¸ë¦¬ë³´ê¸°</th>
                            <th class="extract-embedded">ë‚´ì¥ìë§‰</th>
                        </tr>
                    </thead>
                    <tbody id="file-list">
                        <tr><td colspan="8">íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
            <!-- [ì™„ë£Œëœ íŒŒì¼ ì˜ì—­ ì‹œì‘] -->
            <div id="completed-list" class="completed-list">
                <h3>ì™„ë£Œëœ íŒŒì¼</h3>
                <ul id="completed-files">
                    <!-- ì™„ë£Œëœ íŒŒì¼ ëª©ë¡ (ë‹¤ìš´ë¡œë“œ ë§í¬ í¬í•¨) -->
                </ul>
            </div>
            <!-- [ì™„ë£Œëœ íŒŒì¼ ì˜ì—­ ë] -->
            <!-- [ë°°ì¹˜ ìƒíƒœ ì˜ì—­ ì‹œì‘] -->
            <div id="batch-status" class="batch-status">
                 <!-- ë°°ì¹˜ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ -->
            </div>
            <!-- [ë°°ì¹˜ ìƒíƒœ ì˜ì—­ ë] -->
        </div>
        <!-- [íŒŒì¼ ëª©ë¡ ì˜ì—­ ë] -->
    </div>

    <!-- [ì§„í–‰ë¥  ëª¨ë‹¬ì°½ ì˜ì—­ ì‹œì‘] -->
    <div id="progress-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" id="modal-close">&times;</span>
            <h3>ì§„í–‰ ìƒì„¸ ì •ë³´</h3>
            <div id="modal-file-path"></div>
            <div id="modal-progress-log">(ì§„í–‰ìƒíƒœ/ë¡œê·¸ í‘œì‹œ ì˜ˆì •)</div>
        </div>
    </div>
    <!-- [ì§„í–‰ë¥  ëª¨ë‹¬ì°½ ì˜ì—­ ë] -->

    <!-- ëª¨ë‹¬ ì¶”ê°€ (body í•˜ë‹¨) -->
    <div id="extract-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" id="extract-modal-close">&times;</span>
        <h3 id="extract-modal-title">ë‚´ì¥ ìë§‰ ì¶”ì¶œ ê²°ê³¼</h3>
        <div style="margin-bottom:12px;">
          <button id="download-external-btn">ì™¸ë¶€ ìë§‰ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div id="extract-modal-result">(ê²°ê³¼ í‘œì‹œ)</div>
      </div>
    </div>

    <!-- í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ ì¶”ê°€ -->
    <button id="sidebar-toggle" style="display:block !important;position:fixed;top:16px;left:16px;z-index:9999;font-size:2.2em;background:#fff;border:2px solid #3498db;color:#3498db;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);cursor:pointer;padding:2px 12px 2px 10px;">â˜°</button>

    <script>
        // ìƒìˆ˜ ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const clientId = "{{ client_id }}";
        let websocket;
        let isProcessing = false;
        let currentRelativePath = "{{ initial_path }}";
        
        // íŒŒì¼ ê²½ë¡œ ê´€ë ¨ ìœ í‹¸ë¦¬í‹°
        const Path = {
            basename: function(path) {
                return path.split(/[\\/]/).pop();
            },
            dirname: function(path) {
                return path.split(/[\\/]/).slice(0, -1).join('/');
            },
            join: function(...parts) {
                return parts.filter(part => part && part !== '').join('/');
            }
        };

        // í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        // WebSocket ê´€ë ¨ í•¨ìˆ˜
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws/${clientId}`;
            console.log("WebSocket ì—°ê²° ì‹œë„:", wsUrl);
            
            // ê¸°ì¡´ ì—°ê²° ë‹«ê¸°
            if (websocket && websocket.readyState !== WebSocket.CLOSED) {
                websocket.close();
            }
            
            websocket = new WebSocket(wsUrl);

            websocket.onopen = (event) => {
                console.log("WebSocket ì—°ê²° ì„±ê³µ");
            };

            websocket.onmessage = (event) => {
                handleWebSocketMessage(event.data);
            };

            websocket.onclose = (event) => {
                console.log("WebSocket ì—°ê²° ëŠê¹€. ì½”ë“œ:", event.code, "ì´ìœ :", event.reason);
                isProcessing = false;
                updateUIState();
                
                // 10ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„ (ì„œë²„ê°€ ì¬ì‹œì‘ë  ê²½ìš°)
                setTimeout(() => {
                    if (!isProcessing) {
                        console.log("WebSocket ì¬ì—°ê²° ì‹œë„...");
                        connectWebSocket();
                    }
                }, 10000);
            };

            websocket.onerror = (error) => {
                console.error("WebSocket ì˜¤ë¥˜ ë°œìƒ:", error);
                isProcessing = false;
                updateUIState();
            };
        }

        window.whisperLogs = {};
        window.completedFiles = [];

        function handleWebSocketMessage(message) {
            try {
                const data = JSON.parse(message);
                console.log("WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :", data);
                const fileRow = findRowByPath(data.file_path);
                // Whisper ë¡œê·¸ ëˆ„ì  (status_update, log ëª¨ë‘)
                if (data.file_path) {
                    if (!window.whisperLogs[data.file_path]) window.whisperLogs[data.file_path] = [];
                    if (data.type === 'status_update' || data.type === 'log') {
                        window.whisperLogs[data.file_path].push({
                            time: new Date().toLocaleTimeString(),
                            status: data.status,
                            message: data.message,
                            progress: data.progress_percent,
                            type: data.type
                        });
                    }
                }
                // Whisper ì‘ì—… ì´ë ¥ ê´€ë¦¬
                if (data.type === 'status_update' && ["completed","skipped","error","cancelled"].includes(data.status)) {
                    // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ë“±ë¡ëœ íŒŒì¼ì€ ê±´ë„ˆëœ€
                    if (!window.completedFiles.find(f => f.file_path === data.file_path && f.status === data.status)) {
                        window.completedFiles.push({
                            file_path: data.file_path,
                            file_name: data.file_path ? data.file_path.split(/[\\\/]/).pop() : '',
                            status: data.status,
                            output_path: data.output_path,
                            message: data.message,
                            language: data.language,
                            subtitle_preview: data.subtitle_preview
                        });
                        renderCompletedFiles();
                    }
                }
                if (data.type === "status_update") {
                    if (fileRow) {
                        const statusCell = fileRow.querySelector(".status");
                        const progressCell = fileRow.querySelector(".progress");
                        const subtitleCell = fileRow.querySelector(".subtitle-preview");
                        const checkbox = fileRow.querySelector(".file-checkbox");

                        statusCell.textContent = data.message;
                        progressCell.textContent = data.status;
                        fileRow.className = `status-${data.status}`;

                        if (data.status === "completed") {
                             statusCell.innerHTML = `<a href="/download?file_path=${encodeURIComponent(data.output_path)}" target="_blank">ë‹¤ìš´ë¡œë“œ</a>`;
                            if (data.subtitle_preview) {
                                subtitleCell.innerHTML = `<pre>${escapeHtml(data.subtitle_preview)}</pre>`;
                            }
                            checkbox.checked = false;
                            checkbox.disabled = true;
                        } else if (data.status === "skipped" || data.status === "error" || data.status === "cancelled") {
                            checkbox.checked = false;
                            checkbox.disabled = true;
                        } else {
                            checkbox.disabled = true;
                            subtitleCell.textContent = '-';
                        }

                        // ì§„í–‰ë¥  bar ìƒì„± ë° ê°±ì‹ 
                        let progressBar = progressCell.querySelector('.progress-bar');
                        if (!progressBar) {
                            progressCell.innerHTML = `<div class="progress-bar-container"><div class="progress-bar" style="width:0%"></div></div>`;
                            progressBar = progressCell.querySelector('.progress-bar');
                            // í´ë¦­ ì´ë²¤íŠ¸(ëª¨ë‹¬)
                            progressBar.parentElement.onclick = () => {
                                showProgressModal(data.file_path);
                            };
                        }
                        // ì§„í–‰ë¥ (%) ì ìš© (data.progress_percentê°€ ìˆìœ¼ë©´)
                        if (typeof data.progress_percent === 'number') {
                            progressBar.style.width = `${data.progress_percent}%`;
                            progressBar.textContent = `${data.progress_percent}%`;
                        } else {
                            progressBar.style.width = '0%';
                            progressBar.textContent = '';
                        }
                    } else {
                        console.warn("Status update for unknown file path:", data.file_path);
                    }
                } else if (data.type === "batch_start") {
                    console.log(`ë°°ì¹˜ ì‘ì—… ì‹œì‘: ì´ ${data.total_files}ê°œ íŒŒì¼`);
                    isProcessing = true;
                    updateUIState();
                    document.getElementById("batch-status").textContent = `ì²˜ë¦¬ ì‹œì‘: ì´ ${data.total_files}ê°œ íŒŒì¼...`;
                    document.getElementById("completed-files").innerHTML = '';

                } else if (data.type === "batch_complete" || data.type === "batch_cancelled") {
                     const statusMsg = data.type === "batch_complete" ? "ì™„ë£Œ" : "ì·¨ì†Œ/ì¢…ë£Œ";
                    console.log(`ë°°ì¹˜ ì‘ì—… ${statusMsg}: ì™„ë£Œ ${data.completed_count}, ê±´ë„ˆëœ€ ${data.skipped_count}, ì˜¤ë¥˜ ${data.error_count}, ì·¨ì†Œ ${data.cancelled_count}`);
                    isProcessing = false;
                    updateUIState();
                    document.getElementById("batch-status").textContent =
                        `ì‘ì—… ${statusMsg}: ì´ ${data.total_files}ê°œ ì¤‘ ` +
                        `ì™„ë£Œ ${data.completed_count}, ê±´ë„ˆëœ€ ${data.skipped_count}, ì˜¤ë¥˜ ${data.error_count}, ì·¨ì†Œ ${data.cancelled_count}.`;

                     document.querySelectorAll('#file-list tr').forEach(row => {
                         const checkbox = row.querySelector('.file-checkbox');
                         if (!row.className.includes('status-completed') &&
                             !row.className.includes('status-skipped') &&
                             !row.className.includes('status-error') &&
                             !row.className.includes('status-cancelled')) {
                             checkbox.disabled = false;
                         }
                     });
                } else if (data.type === "stop_acknowledged") {
                    console.log("ì„œë²„ì—ì„œ ì¤‘ì§€ ìš”ì²­ í™•ì¸ë¨.");
                    document.getElementById("batch-status").textContent = "ì²˜ë¦¬ ì¤‘ì§€ ìš”ì²­ë¨...";
                }

            } catch (error) {
                console.error("WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", error, "ì›ë³¸ ë©”ì‹œì§€:", message);
            }
        }

        function findRowByPath(filePath) {
            if (!filePath) return null;
            return document.querySelector(`tr[data-path="${filePath.replace(/"/g, '\\"')}"]`);
        }

        function updateUIState() {
            const runButton = document.getElementById('run-whisper');
            const stopButton = document.getElementById('stop-whisper');
            const checkboxes = document.querySelectorAll('.file-checkbox, #select-all-header');
            const modelSelect = document.getElementById('model-select');

            if (isProcessing) {
                 runButton.disabled = true;
                 stopButton.style.display = 'inline-block';
                 checkboxes.forEach(cb => cb.disabled = true);
                 modelSelect.disabled = true;
                 document.querySelectorAll('button').forEach(btn => {
                     if(btn.id !== 'stop-whisper') btn.disabled = true;
                 });

            } else {
                 runButton.disabled = false;
                 stopButton.style.display = 'none';
                 document.querySelectorAll('#file-list tr').forEach(row => {
                     const checkbox = row.querySelector('.file-checkbox');
                     if (checkbox && !row.className.includes('status-completed') &&
                         !row.className.includes('status-skipped') &&
                         !row.className.includes('status-error') &&
                         !row.className.includes('status-cancelled')) {
                         checkbox.disabled = false;
                     }
                 });
                 if (document.getElementById('select-all-header')) {
                     document.getElementById('select-all-header').disabled = false;
                 }
                 if (modelSelect) {
                     modelSelect.disabled = false;
                 }
                 document.querySelectorAll('button').forEach(btn => {
                     if (btn) btn.disabled = false;
                 });
            }
        }

        // íŠ¸ë¦¬ íƒìƒ‰ ê´€ë ¨ í•¨ìˆ˜ (íƒìƒ‰ê¸° ì˜ì—­)
        /**
         * ë””ë ‰í† ë¦¬ íŠ¸ë¦¬(í´ë” ëª©ë¡) ë¡œë“œ ë° í‘œì‹œ
         * @param {string} relativePath - í˜„ì¬ ìƒëŒ€ ê²½ë¡œ
         */
        async function loadFileTree(relativePath) {
            console.log(`Loading file tree for: ${relativePath}`);
            // ë””ë ‰í† ë¦¬ íŠ¸ë¦¬ ì˜ì—­ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const dirList = document.getElementById('directory-list');
            if (!dirList) {
                console.warn('directory-list DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            dirList.innerHTML = '<li>í´ë” íŠ¸ë¦¬ ë¡œë”© ì¤‘...</li>';

            try {
                const response = await fetch(`/browse?current_path=${encodeURIComponent(relativePath || "")}`);
                if (!response.ok) {
                    throw new Error(`í´ë” íŠ¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(`í´ë” íŠ¸ë¦¬ ì˜¤ë¥˜: ${data.error}`);
                }
                dirList.innerHTML = '';

                // ìƒìœ„ í´ë” ë§í¬ ì¶”ê°€
                if (data.parent_path !== null && data.parent_path !== undefined && 
                    data.parent_path !== relativePath && relativePath !== "") {
                    const parentLi = document.createElement('li');
                    const parentLink = document.createElement('a');
                    parentLink.href = '#';
                    parentLink.className = 'parent-node';
                    parentLink.textContent = '.. (ìƒìœ„ í´ë”)';
                    parentLink.onclick = (e) => {
                        e.preventDefault();
                        navigateTo(data.parent_path);
                    };
                    parentLi.appendChild(parentLink);
                    dirList.appendChild(parentLi);
                }

                // í•˜ìœ„ ë””ë ‰í† ë¦¬ ëª©ë¡ í‘œì‹œ
                if (data.directories && data.directories.length > 0) {
                    console.log(`Found ${data.directories.length} subdirectories.`);
                    data.directories.forEach(dir => {
                        const li = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = '#';
                        // í´ë”ëª… ì˜†ì— (ì˜ìƒ #, ì˜¤ë””ì˜¤ #) í‘œì‹œ (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0)
                        const videoCount = typeof dir.video_count === 'number' ? dir.video_count : 0;
                        const audioCount = typeof dir.audio_count === 'number' ? dir.audio_count : 0;
                        link.textContent = `ğŸ“ ${dir.name} (ì˜ìƒ ${videoCount}, ì˜¤ë””ì˜¤ ${audioCount})`;
                        link.onclick = (e) => {
                            e.preventDefault();
                            navigateTo(dir.path);
                        };
                        li.appendChild(link);
                        dirList.appendChild(li);
                    });
                } else if (dirList.children.length === 0) {
                    dirList.innerHTML = '<li><span class="empty-node">í•˜ìœ„ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</span></li>';
                }
            } catch (error) {
                console.error("í´ë” íŠ¸ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                dirList.innerHTML = `<li>íƒìƒ‰ê¸° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</li>`;
            }
        }

        /**
         * í´ë” ì´ë™ ë° íŒŒì¼ ëª©ë¡ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
         * @param {string} relativePath - ì´ë™í•  ê²½ë¡œ
         */
        async function navigateTo(relativePath) {
            console.log(`Navigating to: ${relativePath}`);
            currentRelativePath = relativePath || "";  // ë¹ˆ ë¬¸ìì—´ ì²˜ë¦¬
            // URL ì—…ë°ì´íŠ¸ (íŒŒì¼ í•„í„°ëŠ” ì œì™¸, ê²½ë¡œë§Œ ë³€ê²½)
            const url = relativePath ? `/?scan_path=${encodeURIComponent(relativePath)}` : '/';
            history.pushState({ path: relativePath }, '', url);
            // UI ì—…ë°ì´íŠ¸ (í˜„ì¬ ê²½ë¡œ í‘œì‹œ)
            const pathDisplay = document.getElementById('current-path-display');
            if (pathDisplay) {
                pathDisplay.textContent = `í˜„ì¬ ê²½ë¡œ: /${relativePath || ''}`;
            }
            const fileListHeader = document.getElementById('file-list-header');
            if (fileListHeader) {
                fileListHeader.textContent = 
                    'ë¯¸ë””ì–´ íŒŒì¼ ëª©ë¡ (' + (relativePath ? '/' + relativePath : 'ë£¨íŠ¸') + ')';
            }
            try {
                // íŠ¸ë¦¬ êµ¬ì¡° ë¡œë“œ
                await loadFileTree(relativePath);
                // íŒŒì¼ ëª©ë¡ì€ ë¡œë“œí•˜ì§€ ì•Šê³  ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                const fileListBody = document.getElementById('file-list');
                if (fileListBody) {
                    fileListBody.innerHTML = '<tr><td colspan="8">ì´ í´ë”ì˜ ë¯¸ë””ì–´ íŒŒì¼ì„ ê²€ìƒ‰í•˜ë ¤ë©´ "í˜„ì¬ í´ë” ê²€ìƒ‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</td></tr>';
                }
            } catch (error) {
                console.error("íƒìƒ‰ ì˜¤ë¥˜:", error);
                alert(`ê²½ë¡œ íƒìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        async function scanCurrentDirectory() {
            console.log(`Scanning current directory: ${currentRelativePath}`);
            document.getElementById("batch-status").textContent = "íŒŒì¼ ê²€ìƒ‰ ì¤‘...";
            try {
                await loadFileList(currentRelativePath);
                // document.getElementById("batch-status").textContent = "íŒŒì¼ ê²€ìƒ‰ ì™„ë£Œ"; // ìƒì„¸ ìš”ì•½ì´ ìœ ì§€ë˜ë„ë¡ ì£¼ì„ ì²˜ë¦¬
            } catch (error) {
                console.error("íŒŒì¼ ìŠ¤ìº” ì˜¤ë¥˜:", error);
                document.getElementById("batch-status").textContent = `íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜: ${error.message}`;
                alert(`íŒŒì¼ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        async function loadFileList(relativePath) {
            const fileListBody = document.getElementById('file-list');
            if (fileListBody) {
                fileListBody.innerHTML = '<tr><td colspan="8">íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘...</td></tr>';
            }
            const filterVideo = document.getElementById('filter-video').checked;
            const filterAudio = document.getElementById('filter-audio').checked;
            const subtitleFilter = document.getElementById('subtitle-filter').value;
            try {
                const response = await fetch(`/api/files?scan_path=${encodeURIComponent(relativePath || "")}&filter_video=${filterVideo}&filter_audio=${filterAudio}&subtitle_filter=${subtitleFilter}`);
                if (!response.ok) throw new Error(`íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${response.statusText}`);
                const data = await response.json();
                if (data.error) throw new Error(`íŒŒì¼ ëª©ë¡ ì˜¤ë¥˜: ${data.error}`);
                if (fileListBody) fileListBody.innerHTML = '';
                if (data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const row = document.createElement('tr');
                        row.dataset.path = file.path;
                        row.dataset.type = file.type;
                        row.innerHTML = `
                            <td><input type="checkbox" class="file-checkbox" ${file.has_subtitle ? 'disabled' : ''}></td>
                            <td class="status">ëŒ€ê¸°</td>
                            <td class="progress">-</td>
                            <td class="filename">${escapeHtml(file.name)}</td>
                            <td class="lang-code">${file.language || '-'}</td>
                            <td class="subtitle-status">${file.has_subtitle ? 'O' : 'X'}</td>
                            <td class="subtitle-preview">-</td>
                            <td class="extract-embedded"><button class="extract-btn" title="ë‚´ì¥ ìë§‰ ì¶”ì¶œ">ğŸ“</button></td>
                        `;
                        fileListBody.appendChild(row);
                    });
                } else {
                    if (fileListBody) fileListBody.innerHTML = '<tr><td colspan="8">ìë§‰ ì—†ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                if (fileListBody) fileListBody.innerHTML = `<tr><td colspan="8">íŒŒì¼ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        function filterTableClientSide() {
            const filterVideo = document.getElementById('filter-video').checked;
            const filterAudio = document.getElementById('filter-audio').checked;
            const searchQuery = document.getElementById('file-search').value.toLowerCase();
            const rows = document.querySelectorAll('#file-list tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const fileType = row.dataset.type;
                const fileName = row.querySelector('.filename').textContent.toLowerCase();
                let showRow = false;

                if (fileType === 'video' && filterVideo) {
                    showRow = true;
                }
                if (fileType === 'audio' && filterAudio) {
                    showRow = true;
                }
                if (searchQuery && !fileName.includes(searchQuery)) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            // ì•„ë¬´ê²ƒë„ í‘œì‹œë˜ì§€ ì•ŠëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
            if (visibleCount === 0 && rows.length > 0) {
                const fileListBody = document.getElementById('file-list');
                fileListBody.innerHTML += `<tr><td colspan="8">ì„ íƒí•œ í•„í„°ì— í•´ë‹¹í•˜ëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            }
        }

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ì´ˆê¸°í™”
        window.onload = () => {
            // WebSocket ì—°ê²°
            connectWebSocket();
            
            // ì´ˆê¸° ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ëª©ë¡ ë¡œë“œ
            navigateTo(currentRelativePath);

            // ì‘ì—… í˜„í™© í•­ìƒ í‘œì‹œ: ìƒ˜í”Œ renderJobList í˜¸ì¶œ ì œê±°, ì‹¤ì œ fetchAndRenderJobs í˜¸ì¶œ
            fetchAndRenderJobs();

            // Whisper ìë§‰ ìƒì„±ê¸° íƒ€ì´í‹€ í´ë¦­ ì‹œ í™ˆìœ¼ë¡œ ì´ë™ ë° UI ì´ˆê¸°í™”
            const appTitle = document.getElementById('app-title');
            if (appTitle) {
                appTitle.onclick = function() {
                    // ì£¼ì†Œë¥¼ í™ˆìœ¼ë¡œ ì´ë™
                    window.history.pushState({}, '', '/');
                    // ê²½ë¡œ ë° UI ìƒíƒœ ì´ˆê¸°í™”
                    currentRelativePath = '';
                    navigateTo('');
                    // ì²´í¬ë°•ìŠ¤, í•„í„°, ê²€ìƒ‰ì–´, ì§„í–‰ìƒíƒœ ë“± ëª¨ë‘ ì´ˆê¸°í™”
                    document.getElementById('file-search').value = '';
                    document.getElementById('filter-video').checked = true;
                    document.getElementById('filter-audio').checked = true;
                    document.getElementById('subtitle-filter').value = 'no_subtitle';
                    document.getElementById('model-select').value = 'base';
                    document.getElementById('whisper-lang').value = 'auto';
                    document.getElementById('batch-status').textContent = '';
                    // íŒŒì¼ ëª©ë¡, ì™„ë£Œ ëª©ë¡, ì‘ì—… í˜„í™© ë“±ë„ ì´ˆê¸°í™”
                    const fileListBody = document.getElementById('file-list');
                    if (fileListBody) fileListBody.innerHTML = '<tr><td colspan="8">ìë§‰ ì—†ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    const completedFiles = document.getElementById('completed-files');
                    if (completedFiles) completedFiles.innerHTML = '';
                    // ì‘ì—… í˜„í™©ì€ ì‹¤ì œ fetchAndRenderJobsë¡œ ê°±ì‹ 
                    fetchAndRenderJobs();
                };
            }

            // ì²´í¬ë°•ìŠ¤ ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            const selectAllHeader = document.getElementById('select-all-header');
            
            selectAllHeader.addEventListener('change', (event) => {
                document.querySelectorAll('#file-list .file-checkbox').forEach(checkbox => {
                    if (!checkbox.disabled && checkbox.closest('tr').style.display !== 'none') {
                        checkbox.checked = event.target.checked;
                    }
                });
            });

            document.getElementById('select-all').addEventListener('click', () => {
                document.querySelectorAll('#file-list .file-checkbox').forEach(checkbox => {
                    if (!checkbox.disabled && checkbox.closest('tr').style.display !== 'none') {
                        checkbox.checked = true;
                    }
                });
                selectAllHeader.checked = true;
            });
            
            document.getElementById('deselect-all').addEventListener('click', () => {
                document.querySelectorAll('#file-list .file-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllHeader.checked = false;
            });

            // Whisper ì‹¤í–‰ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            document.getElementById('run-whisper').addEventListener('click', async () => {
                const selectedFiles = [];
                document.querySelectorAll('#file-list .file-checkbox:checked').forEach(checkbox => {
                    if (checkbox.closest('tr').style.display !== 'none') {
                        selectedFiles.push(checkbox.closest('tr').dataset.path);
                    }
                });

                if (selectedFiles.length === 0) {
                    alert('ìë§‰ì„ ìƒì„±í•  íŒŒì¼ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const modelSize = document.getElementById('model-select').value;
                const language = document.getElementById('whisper-lang').value;
                document.getElementById("batch-status").textContent = "ì„œë²„ì— ì²˜ë¦¬ ìš”ì²­ ì¤‘...";
                
                try {
                    const response = await fetch('/run-whisper', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            files: selectedFiles, 
                            client_id: clientId, 
                            model_size: modelSize,
                            language: language
                        }),
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        console.log("Whisper ì‘ì—… ì‹œì‘ë¨:", result);
                        document.getElementById("batch-status").textContent = result.message;
                    } else {
                        console.error("Whisper ì‘ì—… ì‹œì‘ ì‹¤íŒ¨:", result);
                        document.getElementById("batch-status").textContent = `ì˜¤ë¥˜: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                        alert(`ì˜¤ë¥˜: ${result.detail || 'Whisper ì‘ì—… ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}`);
                        isProcessing = false;
                        updateUIState();
                    }
                } catch (error) {
                    console.error('Whisper ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                    document.getElementById("batch-status").textContent = "ì˜¤ë¥˜: ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
                    alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    isProcessing = false;
                    updateUIState();
                }
            });

            // ì¤‘ì§€ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            document.getElementById('stop-whisper').addEventListener('click', () => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    console.log("Whisper ì²˜ë¦¬ ì¤‘ì§€ ìš”ì²­ ì „ì†¡");
                    websocket.send(JSON.stringify({ type: 'stop_processing' }));
                } else {
                    console.warn("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ì¤‘ì§€ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    alert("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.");
                }
            });

            // ìŠ¤ìº” ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            document.getElementById('scan-directory').addEventListener('click', () => {
                scanCurrentDirectory();
            });

            // ê²€ìƒ‰ í•„í„° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            document.getElementById('file-search').addEventListener('input', () => {
                filterTableClientSide();
            });

            // ë¸Œë¼ìš°ì € ë‚´ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸°)
            window.onpopstate = (event) => {
                if (event.state && event.state.path !== undefined) {
                    console.log("History popstate event:", event.state.path);
                    currentRelativePath = event.state.path;
                    loadFileTree(currentRelativePath);
                    loadFileList(currentRelativePath);
                } else {
                    const params = new URLSearchParams(window.location.search);
                    const pathFromUrl = params.get('scan_path') || '';
                    console.log("History popstate event (no state): path from URL=", pathFromUrl);
                    if (pathFromUrl !== currentRelativePath) {
                        currentRelativePath = pathFromUrl;
                        loadFileTree(currentRelativePath);
                        loadFileList(currentRelativePath);
                    }
                }
            };

            const modelDescriptions = {
                tiny: "ê°€ì¥ ë¹ ë¦„, ì €ì‚¬ì–‘ PC/í…ŒìŠ¤íŠ¸ìš© (ê¶Œì¥: 1ë¶„ ë¯¸ë§Œ/1ì‹œê°„ ì˜ìƒ)",
                base: "ë¹ ë¦„, ì¼ìƒì  ì‚¬ìš©/ì €ì‚¬ì–‘ PC (ê¶Œì¥: 2~3ë¶„/1ì‹œê°„ ì˜ìƒ)",
                small: "ì¤‘ê°„ ì†ë„, ì¼ë°˜ PC/ì„œë²„ (ê¶Œì¥: 5~10ë¶„/1ì‹œê°„ ì˜ìƒ)",
                medium: "ëŠë¦¼, ê³ ì„±ëŠ¥ PC/ì„œë²„ (ê¶Œì¥: 15~30ë¶„/1ì‹œê°„ ì˜ìƒ)",
                large: "ë§¤ìš° ëŠë¦¼, ê³ ì„±ëŠ¥ GPU í•„ìˆ˜ (ê¶Œì¥: 30ë¶„ ì´ìƒ/1ì‹œê°„ ì˜ìƒ)"
            };
            const langDescriptions = {
                auto: "ìë™ ì¸ì‹: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ê¶Œì¥ (ì–¸ì–´ í˜¼í•©/ë¶ˆí™•ì‹¤ ì‹œ)",
                en: "ì˜ì–´: ì˜ì–´ë§Œ í¬í•¨ëœ ì˜ìƒì— ê¶Œì¥",
                ko: "í•œêµ­ì–´: í•œêµ­ì–´ë§Œ í¬í•¨ëœ ì˜ìƒì— ê¶Œì¥",
                ja: "ì¼ë³¸ì–´: ì¼ë³¸ì–´ë§Œ í¬í•¨ëœ ì˜ìƒì— ê¶Œì¥",
                zh: "ì¤‘êµ­ì–´: ì¤‘êµ­ì–´ë§Œ í¬í•¨ëœ ì˜ìƒì— ê¶Œì¥",
                fr: "í”„ë‘ìŠ¤ì–´: í”„ë‘ìŠ¤ì–´ë§Œ í¬í•¨ëœ ì˜ìƒì— ê¶Œì¥"
            };
            function updateModelDesc() {
                const sel = document.getElementById('model-select');
                const desc = document.getElementById('model-desc');
                desc.textContent = modelDescriptions[sel.value] || '';
            }
            function updateLangDesc() {
                const sel = document.getElementById('whisper-lang');
                const desc = document.getElementById('lang-desc');
                desc.textContent = langDescriptions[sel.value] || '';
            }
            document.getElementById('model-select').addEventListener('change', updateModelDesc);
            document.getElementById('whisper-lang').addEventListener('change', updateLangDesc);
            updateModelDesc();
            updateLangDesc();

            // ìë§‰ í•„í„° ë³€ê²½ ì‹œ íŒŒì¼ ëª©ë¡ ìë™ ê°±ì‹ 
            const subtitleFilter = document.getElementById('subtitle-filter');
            if (subtitleFilter) {
                subtitleFilter.addEventListener('change', () => {
                    scanCurrentDirectory();
                });
            }
        };

        // ëª¨ë‹¬ì°½ ê´€ë ¨ í•¨ìˆ˜
        function showProgressModal(filePath) {
            // ëª¨ë‹¬ ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const modal = document.getElementById('progress-modal');
            const filePathElem = document.getElementById('modal-file-path');
            const logElem = document.getElementById('modal-progress-log');
            if (!modal || !filePathElem || !logElem) {
                console.warn('ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            modal.style.display = 'block';
            filePathElem.textContent = filePath;
            // ë¡œê·¸ í‘œì‹œ
            const logs = window.whisperLogs[filePath] || [];
            if (logs.length === 0) {
                logElem.innerHTML = '<span style="color:#888;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
            } else {
                logElem.innerHTML = logs.map(l => `<div style='margin-bottom:4px;'><span style='color:#888;font-size:0.95em;'>[${l.time}]</span> <b>${l.status || ''}</b> <span style='color:#aaa;'>(${l.type})</span> - ${l.message} <span style='color:#3498db;'>(${l.progress ?? '-'}%)</span></div>`).join('');
            }
        }
        // ìë§‰ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í•¨ìˆ˜ (ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ í¬í•¨)
        function showSubtitleModal(subtitle, filename, filePath) {
            const modal = document.getElementById('progress-modal');
            const filePathElem = document.getElementById('modal-file-path');
            const logElem = document.getElementById('modal-progress-log');
            if (!modal || !filePathElem || !logElem) {
                console.warn('ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            modal.style.display = 'block';
            filePathElem.textContent = filename + ' - ìë§‰ ë¯¸ë¦¬ë³´ê¸°';
            // ë²„íŠ¼ ì˜ì—­ ìƒì„±
            let btnArea = document.createElement('div');
            btnArea.style.margin = '8px 0 12px 0';
            // ìˆ˜ì • ë²„íŠ¼
            let editBtn = document.createElement('button');
            editBtn.textContent = 'ìˆ˜ì •';
            editBtn.style.marginRight = '8px';
            // ì‚­ì œ ë²„íŠ¼
            let deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ì‚­ì œ';
            deleteBtn.style.background = '#e74c3c';
            deleteBtn.style.color = '#fff';
            // ë²„íŠ¼ ì‚½ì…
            logElem.innerHTML = '';
            logElem.appendChild(btnArea);
            btnArea.appendChild(editBtn);
            btnArea.appendChild(deleteBtn);
            // ìë§‰ ë‚´ìš© í‘œì‹œ
            let pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap';
            pre.textContent = subtitle;
            logElem.appendChild(pre);
            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ textareaë¡œ ì „í™˜
            editBtn.onclick = function() {
                pre.style.display = 'none';
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
                let textarea = document.createElement('textarea');
                textarea.value = subtitle;
                textarea.style.width = '100%';
                textarea.style.height = '320px';
                textarea.style.marginBottom = '8px';
                logElem.appendChild(textarea);
                // ì €ì¥/ì·¨ì†Œ ë²„íŠ¼
                let saveBtn = document.createElement('button');
                saveBtn.textContent = 'ì €ì¥';
                saveBtn.style.marginRight = '8px';
                let cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'ì·¨ì†Œ';
                logElem.appendChild(saveBtn);
                logElem.appendChild(cancelBtn);
                saveBtn.onclick = async function() {
                    saveBtn.disabled = true;
                    try {
                        const res = await fetch('/api/update_subtitle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_path: filePath, content: textarea.value })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('ìë§‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            showSubtitleModal(textarea.value, filename, filePath);
                        } else {
                            alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            saveBtn.disabled = false;
                        }
                    } catch (e) {
                        alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
                        saveBtn.disabled = false;
                    }
                };
                cancelBtn.onclick = function() {
                    showSubtitleModal(subtitle, filename, filePath);
                };
            };
            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            deleteBtn.onclick = async function() {
                if (!confirm('ì •ë§ë¡œ ì´ ìë§‰ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                deleteBtn.disabled = true;
                try {
                    const res = await fetch('/api/delete_subtitle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: filePath })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert('ìë§‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ì™„ë£Œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
                        window.completedFiles = window.completedFiles.filter(f => f.output_path !== filePath);
                        renderCompletedFiles();
                        modal.style.display = 'none';
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        deleteBtn.disabled = false;
                    }
                } catch (e) {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
                    deleteBtn.disabled = false;
                }
            };
        }
        // ìë§‰ ë¯¸ë¦¬ë³´ê¸° API í˜¸ì¶œ ë° ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
        async function previewSubtitle(filePath, fileName) {
            try {
                const res = await fetch(`/api/preview_subtitle?file_path=${encodeURIComponent(filePath)}&max_lines=200`);
                const data = await res.json();
                if (data.success && data.lines) {
                    showSubtitleModal(data.lines.join('\n'), fileName, filePath);
                } else {
                    showSubtitleModal('ìë§‰ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ' + (data.error || ''), fileName, filePath);
                }
            } catch (e) {
                showSubtitleModal('ìë§‰ ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + e.message, fileName, filePath);
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (null ì²´í¬ ì¶”ê°€)
        const modalCloseBtn = document.getElementById('modal-close');
        if (modalCloseBtn) {
            modalCloseBtn.onclick = function() {
                const modal = document.getElementById('progress-modal');
                if (modal) modal.style.display = 'none';
            };
        }
        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (null ì²´í¬ ì¶”ê°€)
        window.onclick = function(event) {
            const modal = document.getElementById('progress-modal');
            if (modal && event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Whisper ì‘ì—… ëª©ë¡ì„ ì„œë²„ì—ì„œ ë°›ì•„ì™€ ë Œë”ë§
        async function fetchAndRenderJobs() {
            try {
                const res = await fetch('/api/jobs');
                const data = await res.json();
                if (data.jobs) {
                    renderJobList(data.jobs);
                } else {
                    renderJobList([]);
                }
            } catch (e) {
                renderJobList([]);
            }
        }

        // ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— ëª…ë ¹ ì „ì†¡
        async function sendJobAction(jobId, action) {
            try {
                await fetch(`/api/job/${jobId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                // ìƒíƒœ ê°±ì‹ 
                fetchAndRenderJobs();
            } catch (e) {
                alert('ì‘ì—… ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨');
            }
        }

        // ì‘ì—… í˜„í™© ë Œë”ë§ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
        function renderJobList(jobs) {
            const jobList = document.getElementById('job-list');
            if (!jobList) return;
            jobList.innerHTML = '';
            if (!jobs || jobs.length === 0) {
                jobList.innerHTML = '<li style="color:#888;">ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            // ì§„í–‰ì¤‘/ì¼ì‹œì •ì§€ ìƒíƒœ 1ê°œë§Œ ì²« ì¤„, ë‚˜ë¨¸ì§€ëŠ” ì•„ë˜
            let mainJob = jobs.find(j => j.status === 'ì§„í–‰ì¤‘' || j.status === 'ì¼ì‹œì •ì§€') || jobs[0];
            let otherJobs = jobs.filter(j => j !== mainJob);
            // ë©”ì¸ ì‘ì—…(2ì¤„)
            if (mainJob) {
                const li = document.createElement('li');
                li.style.display = 'block';
                li.style.marginBottom = '10px';
                li.innerHTML = `
                  <div style="font-weight:500;font-size:1em;">
                    <span class="job-filename" style="cursor:pointer;color:#1a5dab;" title="ìƒì„¸ ë³´ê¸°">${mainJob.filename} <span style='color:#888;font-weight:400;font-size:0.97em;'>(${mainJob.language}, ${mainJob.model})</span></span>
                  </div>
                  <div style="margin-top:2px;display:flex;align-items:center;gap:4px;">
                    <span style="width:54px;">${mainJob.progress}%</span>
                    <span style="color:#888;">${mainJob.status}</span>
                    <button class="job-btn" data-action="pause" title="ì¼ì‹œì •ì§€">â¸ï¸</button>
                    <button class="job-btn" data-action="stop" title="ì¤‘ë‹¨">ğŸ›‘</button>
                    <button class="job-btn" data-action="resume" title="ì¬ê°œ">â–¶ï¸</button>
                    <button class="job-btn job-delete" data-action="delete" title="ì‚­ì œ">âŒ</button>
                  </div>
                `;
                li.querySelector('.job-filename').onclick = function() {
                    showProgressModal(mainJob.filename);
                };
                // ìƒíƒœë³„ ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
                li.querySelector('[data-action="pause"]').disabled = mainJob.status !== 'ì§„í–‰ì¤‘';
                li.querySelector('[data-action="stop"]').disabled = mainJob.status === 'ì™„ë£Œ' || mainJob.status === 'ì¤‘ë‹¨ë¨';
                li.querySelector('[data-action="resume"]').disabled = mainJob.status !== 'ì¼ì‹œì •ì§€';
                // ë²„íŠ¼ ì´ë²¤íŠ¸
                li.querySelector('[data-action="pause"]').onclick = function() {
                    sendJobAction(mainJob.id, 'pause');
                };
                li.querySelector('[data-action="stop"]').onclick = function() {
                    sendJobAction(mainJob.id, 'stop');
                };
                li.querySelector('[data-action="resume"]').onclick = function() {
                    sendJobAction(mainJob.id, 'resume');
                };
                li.querySelector('.job-delete').onclick = function() {
                    sendJobAction(mainJob.id, 'delete');
                };
                jobList.appendChild(li);
            }
            // ë‚˜ë¨¸ì§€ ì‘ì—…(ì‘ê²Œ, í•œ ì¤„ì— ì—¬ëŸ¬ ê°œ)
            if (otherJobs.length > 0) {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.flexWrap = 'wrap';
                li.style.gap = '8px';
                otherJobs.forEach(job => {
                    const jobBox = document.createElement('span');
                    jobBox.style.display = 'inline-flex';
                    jobBox.style.alignItems = 'center';
                    jobBox.style.background = '#f3f6fa';
                    jobBox.style.borderRadius = '5px';
                    jobBox.style.padding = '2px 6px 2px 4px';
                    jobBox.style.marginBottom = '2px';
                    jobBox.style.fontSize = '0.97em';
                    jobBox.innerHTML = `
                      <span class="job-filename" style="cursor:pointer;color:#1a5dab;" title="ìƒì„¸ ë³´ê¸°">${job.filename} <span style='color:#888;font-weight:400;font-size:0.97em;'>(${job.language}, ${job.model})</span></span>
                      <span style="margin:0 4px 0 6px;color:#888;">${job.status}</span>
                      <button class="job-btn job-delete" data-action="delete" title="ì‚­ì œ">âŒ</button>
                    `;
                    jobBox.querySelector('.job-filename').onclick = function() {
                        showProgressModal(job.filename);
                    };
                    jobBox.querySelector('.job-delete').onclick = function() {
                        sendJobAction(job.id, 'delete');
                    };
                    li.appendChild(jobBox);
                });
                jobList.appendChild(li);
            }
        }

        // 3ì´ˆë§ˆë‹¤ ì‘ì—… ëª©ë¡ í´ë§
        setInterval(fetchAndRenderJobs, 3000);

        // ë‚´ì¥ ìë§‰ ì¶”ì¶œ ëª¨ë‹¬ í•¨ìˆ˜ ì¶”ê°€
        async function showExtractModal(mediaPath, fileName) {
            const modal = document.getElementById('extract-modal');
            const resultDiv = document.getElementById('extract-modal-result');
            const title = document.getElementById('extract-modal-title');
            if (!modal || !resultDiv || !title) return;
            modal.style.display = 'block';
            title.textContent = `ë‚´ì¥ ìë§‰ ì¶”ì¶œ ê²°ê³¼: ${fileName}`;
            resultDiv.innerHTML = 'ìë§‰ ì¶”ì¶œ ì¤‘...';
            try {
                const res = await fetch('/api/extract_subtitles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ media_path: mediaPath })
                });
                const data = await res.json();
                if (data.error) {
                    resultDiv.innerHTML = `<span style='color:#d00;'>ì˜¤ë¥˜: ${data.error}</span>`;
                    return;
                }
                if (!data.tracks || data.tracks.length === 0) {
                    resultDiv.innerHTML = '<span>ë‚´ì¥ ìë§‰ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                    return;
                }
                let html = `<table class='subtitle-extract-list'><thead><tr><th>íŠ¸ë™</th><th>ì–¸ì–´</th><th>í¬ë§·</th><th>ê²½ë¡œ</th><th>ìƒíƒœ</th><th>ë¯¸ë¦¬ë³´ê¸°</th><th>ì €ì¥</th></tr></thead><tbody>`;
                data.tracks.forEach(track => {
                    const saveBtn = `<button class='btn-save' data-in='${track.output_path}' data-out='${track.output_path.replace(/\.[^.]+$/, '.srt')}'>SRTë¡œ ì €ì¥</button>`;
                    html += `<tr>
                        <td>${track.track}</td>
                        <td>${track.language}</td>
                        <td>${track.format}</td>
                        <td>${track.output_path}</td>
                        <td>${track.status === 'pending' ? 'ëŒ€ê¸°' : track.status}</td>
                        <td><button class='btn-preview' data-path='${track.output_path}'>ë³´ê¸°</button></td>
                        <td class='save-cell'>${saveBtn}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                resultDiv.innerHTML = html;
                // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                resultDiv.querySelectorAll('.btn-preview').forEach(btn => {
                    btn.onclick = function() {
                        const path = btn.getAttribute('data-path');
                        alert(path + ' (ìƒ˜í”Œ ìë§‰ ë‚´ìš©)');
                    };
                });
                // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
                resultDiv.querySelectorAll('.btn-save').forEach(btn => {
                    btn.onclick = async function() {
                        const inPath = btn.getAttribute('data-in');
                        const outPath = btn.getAttribute('data-out');
                        btn.disabled = true;
                        btn.textContent = 'ì €ì¥ ì¤‘...';
                        try {
                            const res = await fetch('/api/convert_subtitle', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ input_path: inPath, output_path: outPath, target_format: 'srt' })
                            });
                            const data = await res.json();
                            if (data.success) {
                                btn.parentElement.innerHTML = `<span style='color:#1a5dab;font-weight:bold;'>ì €ì¥ ì™„ë£Œ</span>`;
                            } else {
                                btn.disabled = false;
                                btn.textContent = 'SRTë¡œ ì €ì¥';
                                alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            }
                        } catch (e) {
                            btn.disabled = false;
                            btn.textContent = 'SRTë¡œ ì €ì¥';
                            alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
                        }
                    };
                });
            } catch (e) {
                resultDiv.innerHTML = `<span style='color:#d00;'>ì˜¤ë¥˜: ${e.message}</span>`;
            }
        };
        document.getElementById('extract-modal-close').onclick = function() {
            document.getElementById('extract-modal').style.display = 'none';
        };
        window.onclick = function(event) {
            const modal = document.getElementById('extract-modal');
            if (modal && event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // ì™¸ë¶€ ìë§‰ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const downloadBtn = document.getElementById('download-external-btn');
        downloadBtn.onclick = async function() {
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤‘...';
            try {
                const res = await fetch('/api/download_subtitle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: fileName, language: 'ko' })
                });
                const data = await res.json();
                if (!data.success) {
                    alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'ì™¸ë¶€ ìë§‰ ë‹¤ìš´ë¡œë“œ';
                    return;
                }
                if (!data.candidates || data.candidates.length === 0) {
                    alert('ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'ì™¸ë¶€ ìë§‰ ë‹¤ìš´ë¡œë“œ';
                    return;
                }
                let html = `<table class='subtitle-extract-list'><thead><tr><th>íŒŒì¼ëª…</th><th>ì–¸ì–´</th><th>ë‹¤ìš´ë¡œë“œ</th><th>ì‹±í¬ ëŒ€ì¡°</th></tr></thead><tbody>`;
                data.candidates.forEach(cand => {
                    const syncBtn = `<button class='btn-sync' data-media='${mediaPath}' data-sub='${cand.download_url}'>ì‹±í¬ ëŒ€ì¡° ë° ìë™ ì €ì¥</button>`;
                    html += `<tr>
                        <td>${cand.filename}</td>
                        <td>${cand.lang}</td>
                        <td><a href='${cand.download_url}' target='_blank'>ë‹¤ìš´ë¡œë“œ</a></td>
                        <td class='sync-cell'>${syncBtn}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('extract-modal-result').innerHTML = html;
                // ì‹±í¬ ëŒ€ì¡° ë²„íŠ¼ ì´ë²¤íŠ¸
                Array.from(document.querySelectorAll('.btn-sync')).forEach(btn => {
                    btn.onclick = async function() {
                        const mediaPath = btn.getAttribute('data-media');
                        const subPath = btn.getAttribute('data-sub');
                        btn.disabled = true;
                        btn.textContent = 'ëŒ€ì¡° ì¤‘...';
                        try {
                            const res = await fetch('/api/check_subtitle_sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ media_path: mediaPath, subtitle_path: subPath, sample_count: 3 })
                            });
                            const data = await res.json();
                            if (data.success) {
                                // í’ˆì§ˆ ë“±ê¸‰ ê³„ì‚°
                                let grade = 'ë¶ˆëŸ‰';
                                if (data.score >= 0.9) grade = 'ë§¤ìš° ìš°ìˆ˜';
                                else if (data.score >= 0.8) grade = 'ìš°ìˆ˜';
                                else if (data.score >= 0.7) grade = 'ë³´í†µ';
                                // ìƒì„¸ í‘œ ìƒì„±
                                let html = `<div style='margin-bottom:8px;'><b>í‰ê·  ì ìˆ˜:</b> <span style='color:#1a5dab;font-weight:bold;'>${(data.score*100).toFixed(1)}%</span> <b>í’ˆì§ˆ:</b> <span style='color:#1a5dab;'>${grade}</span></div>`;
                                html += `<table class='sync-detail-table' style='width:100%;border-collapse:collapse;font-size:0.97em;'>`;
                                html += `<thead><tr style='background:#f8f8f8;'><th>ìƒ˜í”Œ</th><th>êµ¬ê°„(ì´ˆ)</th><th>ìœ ì‚¬ë„</th><th>STT</th><th>ìë§‰</th></tr></thead><tbody>`;
                                (data.details||[]).forEach(d => {
                                    let simColor = d.similarity >= 0.8 ? '#2ecc71' : (d.similarity >= 0.6 ? '#f39c12' : '#e74c3c');
                                    html += `<tr><td style='text-align:center;'>${d.sample_idx}</td><td style='text-align:center;'>${d.start}~${d.end}</td><td style='text-align:center;color:${simColor};font-weight:bold;'>${(d.similarity*100).toFixed(1)}%</td><td>${escapeHtml(d.stt_text)}</td><td>${escapeHtml(d.subtitle_text)}</td></tr>`;
                                });
                                html += `</tbody></table>`;
                                if (data.sync) {
                                    html += `<div style='margin-top:8px;color:#1a5dab;font-weight:bold;'>ì‹±í¬ ì¼ì¹˜, ìë™ ì €ì¥ ì™„ë£Œ</div>`;
                                } else {
                                    html += `<div style='margin-top:8px;color:#d00;font-weight:bold;'>ì‹±í¬ ë¶ˆì¼ì¹˜</div> <button class='btn-whisper'>Whisperë¡œ ìë§‰ ìƒì„±</button>`;
                                }
                                btn.parentElement.innerHTML = html;
                                // Whisper ë°±ì—… ë²„íŠ¼ ì´ë²¤íŠ¸
                                const whisperBtn = btn.parentElement.querySelector('.btn-whisper');
                                if (whisperBtn) {
                                    whisperBtn.onclick = function() {
                                        alert('Whisper ìë§‰ ìƒì„± í”Œë¡œìš°ë¡œ ì´ë™(í›„ì† êµ¬í˜„)');
                                    };
                                }
                            } else {
                                btn.disabled = false;
                                btn.textContent = 'ì‹±í¬ ëŒ€ì¡° ë° ìë™ ì €ì¥';
                                alert('ì‹±í¬ ëŒ€ì¡° ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            }
                        } catch (e) {
                            btn.disabled = false;
                            btn.textContent = 'ì‹±í¬ ëŒ€ì¡° ë° ìë™ ì €ì¥';
                            alert('ì‹±í¬ ëŒ€ì¡° ì‹¤íŒ¨: ' + e.message);
                        }
                    };
                });
            } catch (e) {
                alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'ì™¸ë¶€ ìë§‰ ë‹¤ìš´ë¡œë“œ';
            }
        };

        // íŒŒì¼ ëª©ë¡ì„ ì¹´ë“œë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
        function renderMediaList(files) {
            const mediaList = document.getElementById('media-list');
            if (!mediaList) return;
            mediaList.innerHTML = '';
            if (!files || files.length === 0) {
                mediaList.innerHTML = '<div class="media-card media-card-empty">ìë§‰ ì—†ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            files.forEach(file => {
                const card = document.createElement('div');
                card.className = 'media-card';
                card.dataset.path = file.path;
                card.innerHTML = `
                    <div class="media-main">
                        <span class="media-filename">${escapeHtml(file.name)}</span>
                        <span class="media-status">ìƒíƒœ: ëŒ€ê¸°</span>
                        <span class="media-lang">ğŸŒ ${file.language || '-'}</span>
                        <span class="media-subtitle">ìë§‰: ${file.has_subtitle ? 'ìˆìŒ' : 'ì—†ìŒ'}</span>
                    </div>
                    <div class="media-actions">
                        <button class="extract-btn">ë‚´ì¥ ìë§‰</button>
                        <button class="preview-btn">ë¯¸ë¦¬ë³´ê¸°</button>
                    </div>
                `;
                mediaList.appendChild(card);
            });
        }

        // í–„ë²„ê±° ë©”ë‰´(ì‚¬ì´ë“œë°”) í† ê¸€ ë™ì‘ ì¶”ê°€
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('directory-browser');
        if (sidebarToggle && sidebar) {
            sidebarToggle.onclick = function(e) {
                e.stopPropagation();
                sidebar.classList.toggle('open');
                // ì˜¤ë²„ë ˆì´ ì¶”ê°€(ëª¨ë°”ì¼)
                if (sidebar.classList.contains('open')) {
                    let overlay = document.createElement('div');
                    overlay.id = 'sidebar-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100vw';
                    overlay.style.height = '100vh';
                    overlay.style.background = 'rgba(0,0,0,0.08)';
                    overlay.style.zIndex = '999';
                    overlay.onclick = function() {
                        sidebar.classList.remove('open');
                        overlay.remove();
                    };
                    document.body.appendChild(overlay);
                } else {
                    const overlay = document.getElementById('sidebar-overlay');
                    if (overlay) overlay.remove();
                }
            };
            // ì‚¬ì´ë“œë°” ë‚´ë¶€ í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ ë‹«í˜ ë°©ì§€
            sidebar.onclick = function(e) {
                e.stopPropagation();
            };
            // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°(ë°ìŠ¤í¬íƒ‘)
            document.body.addEventListener('click', function(e) {
                if (window.innerWidth <= 900 && sidebar.classList.contains('open')) {
                    if (!sidebar.contains(e.target) && e.target !== sidebarToggle) {
                        sidebar.classList.remove('open');
                        const overlay = document.getElementById('sidebar-overlay');
                        if (overlay) overlay.remove();
                    }
                }
            });
        }

        function renderCompletedFiles() {
            const list = document.getElementById('completed-files');
            if (!list) return;
            if (window.completedFiles.length === 0) {
                list.innerHTML = '<li style="color:#888;">ì™„ë£Œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            list.innerHTML = window.completedFiles.map(f => {
                let statusColor = f.status === 'completed' ? '#2ecc71' : (f.status === 'skipped' ? '#f39c12' : (f.status === 'error' ? '#e74c3c' : '#95a5a6'));
                let statusLabel = f.status === 'completed' ? 'ì™„ë£Œ' : (f.status === 'skipped' ? 'ê±´ë„ˆëœ€' : (f.status === 'error' ? 'ì˜¤ë¥˜' : 'ì·¨ì†Œ'));
                let download = f.output_path ? `<a href="/download?file_path=${encodeURIComponent(f.output_path)}" target="_blank" style="color:#3498db;">ë‹¤ìš´ë¡œë“œ</a>` : '';
                let logBtn = `<button onclick="showProgressModal(${JSON.stringify(f.file_path)})" style="margin-left:8px;">ë¡œê·¸ ë³´ê¸°</button>`;
                let previewBtn = f.output_path ? `<button onclick="previewSubtitle('${f.output_path}', '${escapeHtml(f.file_name)}')" style="margin-left:8px;">ìë§‰ ë¯¸ë¦¬ë³´ê¸°</button>` : '';
                let preview = f.subtitle_preview ? `<pre style='background:#f8f8f8;padding:4px 8px;border-radius:3px;margin:4px 0 0 0;'>${escapeHtml(f.subtitle_preview)}</pre>` : '';
                return `<li style="margin-bottom:10px;"><b>${escapeHtml(f.file_name)}</b> <span style="color:${statusColor};font-weight:600;">[${statusLabel}]</span> ${download} ${logBtn} ${previewBtn} ${preview}</li>`;
            }).join('');
        }

        // 901px ì´ìƒì—ì„œëŠ” í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ ìˆ¨ê¹€ ë³´ì¥ (JSë¡œë„ ë³´ì™„)
        function updateSidebarToggleVisibility() {
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (!sidebarToggle) return;
            if (window.innerWidth >= 901) {
                sidebarToggle.style.display = 'none';
            } else {
                sidebarToggle.style.display = 'block';
            }
        }
        window.addEventListener('resize', updateSidebarToggleVisibility);
        document.addEventListener('DOMContentLoaded', updateSidebarToggleVisibility);

        // ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ ì œëª© ë³€ê²½ (ì´ˆê¸°í™” ë° í´ë” ì´ë™ ì‹œ)
        function updateFileListHeader() {
            const fileListHeader = document.getElementById('file-list-header');
            if (fileListHeader) {
                fileListHeader.textContent = 'ë¯¸ë””ì–´ íŒŒì¼ ëª©ë¡ (' + (currentRelativePath ? '/' + currentRelativePath : 'ë£¨íŠ¸') + ')';
            }
        }
        updateFileListHeader();
        // í´ë” ì´ë™ ì‹œì—ë„ ì ìš©
        const origNavigateTo = navigateTo;
        navigateTo = async function(relativePath) {
            await origNavigateTo(relativePath);
            updateFileListHeader();
        };

        // íƒ­ ì „í™˜ ë¡œì§
        function showTab(tab) {
            const tabs = ['extract', 'download', 'whisper'];
            tabs.forEach(t => {
                document.getElementById('tab-' + t).classList.remove('active');
                document.getElementById('tab-content-' + t).style.display = 'none';
            });
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('tab-content-' + tab).style.display = 'block';
        }
        document.getElementById('tab-extract').onclick = () => showTab('extract');
        document.getElementById('tab-download').onclick = () => showTab('download');
        document.getElementById('tab-whisper').onclick = () => showTab('whisper');
        // ì²« ì§„ì… ì‹œ extract íƒ­ë§Œ ë³´ì´ë„ë¡ ì´ˆê¸°í™”
        showTab('extract');
    </script>
</body>
</html>